# Aperture v0.3.4 Release Notes

Hey everyone! üëã

This is a focused update that fixes a frustrating issue several of you have reported with metadata enrichment. Here's what's new:

---

## üîÑ Crash-Resilient Metadata Enrichment

**The Problem:** If your container restarted (or crashed) while metadata enrichment was running, you'd end up in a "limbo state" where:

- The job thought it was finished
- Running enrichment again would say "All items enriched - nothing to do"
- But you could clearly see items that weren't enriched yet
- There was no way to recover without manually poking the database

This happened because the job progress was only tracked in memory. If the process died, that state was lost, but items that _had_ been enriched were marked as complete in the database‚Äîso the job couldn't tell the difference between "finished" and "interrupted."

**The Fix:** I've added persistent run tracking that survives restarts:

- A new `enrichment_runs` table stores the expected vs. actual progress
- Progress is saved to the database after every batch (not just at the end)
- On startup, any "running" jobs are automatically detected and marked as "interrupted"
- The Jobs page now shows a **warning banner** when an interrupted run is detected

**What you'll see:**

When Aperture detects an incomplete enrichment run, you'll see an alert like:

> ‚ö†Ô∏è **Metadata Enrichment Interrupted**  
> A previous enrichment run was interrupted (possibly due to a container restart). **847 movies and 124 series** still need enrichment. (253 movies and 31 series were completed before interruption.)  
> Click **Resume** to continue enrichment, or **Dismiss** to clear this warning.

- **Resume** clears the interrupted state and immediately starts enrichment (it will pick up where it left off)
- **Dismiss** just clears the warning if you want to deal with it later

---

## Technical Details

For those curious about the implementation:

- New migration `0069_enrichment_runs.sql` creates the tracking table
- `detectInterruptedEnrichmentRuns()` is called on API startup
- Progress is persisted every batch (100 items) during enrichment
- Two new API endpoints: `GET /api/jobs/enrichment/status` and `POST /api/jobs/enrichment/clear-interrupted`

---

## Upgrade Notes

After updating to v0.3.4:

1. If you were stuck in a limbo state, you should now see the warning banner on the Jobs page
2. Click **Resume** to finish your enrichment

---

## Full Changelog

### New Features

- Add persistent enrichment run tracking with `enrichment_runs` table
- Detect interrupted enrichment runs on application startup
- Add warning banner in Jobs UI for interrupted enrichment runs
- Add Resume and Dismiss actions for interrupted runs

### Bug Fixes

- Fix enrichment "limbo state" where container restart left job unrecoverable
- Fix inability to resume enrichment after unexpected shutdown

### Technical

- New migration `0069_enrichment_runs.sql`
- New `useEnrichmentStatus` hook for frontend
- New API endpoints for enrichment status management

---

If you've been stuck with incomplete enrichment, this update should get you unstuck. Let me know if you run into any issues! üçø
