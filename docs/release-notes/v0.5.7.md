# Aperture v0.5.7 Release Notes

Hey everyone! ğŸ‘‹

This release fixes a significant performance issue with the Watcher Identity tabs in User Settings. If you've noticed slow load times when switching between Movies and Series tabs, this one's for you!

---

## ğŸ› Fixed: Watcher Identity Auto-Regeneration Bug

### The Problem

The Watcher Identity tabs were triggering a **full AI regeneration** of your taste synopsis on every page load after 24 hours â€” completely ignoring your configured refresh interval setting (e.g., 1 month).

This meant:
- âŒ 5-10+ second load times every day
- âŒ Unnecessary AI API calls
- âŒ Wasted compute on multiple database queries + embedding calculations
- âŒ Your "Refresh Interval" setting in Identity Settings was being ignored

### The Fix

The `getTasteSynopsis()` and `getSeriesTasteSynopsis()` functions no longer auto-regenerate on page load. They now:
- âœ… Return cached synopsis immediately (if exists)
- âœ… Let the background job handle periodic refresh based on your settings
- âœ… Only regenerate when you explicitly click "Generate Identity"

---

## âš¡ Database Query Optimizations

Even with the caching fix, we also optimized the "quick stats" queries that display alongside your identity synopsis.

### Before
- **Movie stats**: 4 sequential database queries
- **Series stats**: 5 sequential database queries

### After
- **Movie stats**: 1 combined CTE query
- **Series stats**: 1 combined CTE query

This reduces database round trips by ~75-80% for the stats that always need to load.

---

## ğŸ“Š New Database Index

Added a composite index to improve series watch history query performance:

```sql
CREATE INDEX idx_watch_history_user_episode_composite 
ON watch_history(user_id, episode_id) 
WHERE episode_id IS NOT NULL;
```

This optimizes the 3-way joins (`watch_history â†’ episodes â†’ series`) that were slower than movie queries.

---

## ğŸš€ Update Instructions

### For Docker Users

```bash
# Pull the latest image
docker compose pull

# Restart with new version
docker compose up -d
```

The new database index will be applied automatically on startup.

---

## ğŸ“‹ Full Changelog

**Bug Fixes:**
- `fix: remove erroneous 24h auto-regeneration from taste synopsis functions`
- `fix: respect user's refresh_interval_days setting for identity updates`

**Performance:**
- `perf: combine 4 sequential movie stats queries into single CTE`
- `perf: combine 5 sequential series stats queries into single CTE`
- `perf: add composite index for series watch history queries`

---

## Expected Performance Impact

| Scenario | Before | After |
|----------|--------|-------|
| Page load (synopsis >24h old) | 5-10+ seconds | ~100-200ms |
| Database queries for stats | 4-5 sequential | 1 combined |

Your Watcher Identity tabs should now load almost instantly! ğŸ‰
