# Aperture v0.6.3 Release Notes

Hey everyone! üëã

This release brings major improvements to series library scanning reliability, especially for users with very large libraries (100K+ episodes). We've also fixed several issues with NFO metadata generation and added real-time job status updates to the Discovery page.

---

## üöÄ Major Improvements

### Reliable Scanning for Very Large Series Libraries

Users with massive TV libraries (200K+ episodes) were experiencing scan failures due to memory exhaustion and timeouts. This release completely overhauls the series sync process:

- **Streaming Batch Processing**: Episodes are now fetched and processed in chunks of 1,000 instead of loading all episodes into memory at once. This keeps memory usage constant regardless of library size.
- **Increased API Timeout**: The timeout for Emby/Jellyfin API requests has been doubled from 30 seconds to 60 seconds, giving slow media servers more time to respond.
- **Accurate Progress Tracking**: Fixed multiple issues where episode counts weren't being accumulated correctly across multiple libraries.
- **Proper Insert vs Update Counting**: The sync now accurately reports which episodes were truly new vs updated, using PostgreSQL's `xmax` system column to distinguish real inserts from upsert updates.

### Discovery Page Real-Time Job Status

The Discovery page now shows real-time progress when the discovery suggestions job is running:

- Animated banner displays current step and progress percentage
- Auto-refreshes the grid when the job completes
- Refresh button is disabled while the job is running

---

## üêõ Bug Fixes

### Fixed: Duplicates in Emby's "Recently Released" Home Rows

Aperture-generated libraries (Top Picks, AI Recommendations) were appearing as duplicates alongside original files in Emby's "Recently Released" home screen rows. NFO files now:

- Set `lockdata=true` to prevent Emby from overwriting metadata
- Remove `premiered` and `releasedate` tags that were causing the duplicates

### Fixed: AI Recommendations Not Sorting by Rank

Movies and series in AI recommendation STRM libraries now sort correctly by recommendation rank using rank-prefixed sort titles (e.g., "01 - Movie Title").

### Fixed: Episodes with Null Season/Episode Numbers Causing Sync Failures

Some media servers return bonus content, extras, or special features with null episode numbers. These now get filtered out during sync instead of causing database constraint violations.

### Fixed: Episode Counts Not Matching Total

The "Episodes Added" + "Episodes Updated" counts now correctly sum to the total episodes processed. Previously, deduplicated episodes (multiple versions of the same episode) weren't being counted.

### Fixed: Episodes Incorrectly Showing as "New" on Every Scan

When Emby/Jellyfin regenerates item IDs, episodes were incorrectly reported as "new" on every sync. The sync now detects existing episodes by both `provider_item_id` AND the `series + season + episode` composite key.

---

## üöÄ Update Instructions

### For Docker Users

```bash
# Pull the latest image
docker compose pull

# Restart with new version
docker compose up -d
```

---

## üìã Full Changelog

**Improvements:**
- `feat(discovery): add real-time job status updates`
- `fix: improve reliability for very large series libraries (200K+ episodes)`

**Bug Fixes:**
- `fix(nfo): prevent duplicates in Recently Released and fix sort order`
- `fix: skip episodes with null season/episode numbers during sync`
- `fix: accumulate episode counts across multiple libraries in streaming sync`
- `fix: correctly count episode inserts vs updates in upsert operation`
- `fix: count deduplicated episodes as updates so added+updated=total`
- `fix: detect existing episodes by series+season+episode key, not just provider_item_id`
