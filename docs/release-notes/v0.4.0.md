# Aperture v0.4.0 Release Notes

Hey everyone! ğŸ‘‹

This is a major feature release introducing **Similarity Graphs** â€” a new interactive way to explore connections between movies and series in your library. Plus, you can now create playlists directly from your graph explorations!

---

## ğŸ•¸ï¸ Similarity Graphs

Discover how your movies and series are connected through directors, actors, genres, collections, and more with our new interactive graph visualization.

### What It Does

On any movie or series detail page, you'll now see a **Graph** tab alongside the traditional list view of similar content. This graph displays:

- **Poster nodes** â€” Each movie/series is shown as its actual poster
- **Color-coded connections** â€” Lines between posters show why they're related:
  - ğŸ”µ **Blue** â€” Same director
  - ğŸŒŠ **Teal** â€” Shared actors
  - ğŸ¥‡ **Gold** â€” Same collection/franchise
  - ğŸ’œ **Purple** â€” Shared genres
  - ğŸ’— **Pink** â€” Shared keywords/themes
  - ğŸŸ  **Orange** â€” Same studio
  - ğŸŸ¢ **Green** â€” Same network (TV)
  - ğŸ©¶ **Gray** â€” Vector similarity (AI-detected)
  - ğŸ’š **Emerald** â€” AI Discovery (bubble breaker)

### Interactive Features

- **Click any poster** to refocus the graph on that item (rabbit-hole exploration!)
- **Double-click** to navigate to that movie/series detail page
- **Drag posters** to rearrange the layout
- **Scroll to zoom** in and out
- **Hover on connections** to see detailed relationship info
- **Breadcrumb navigation** tracks your exploration path

### Fullscreen Mode

Click the **fullscreen button** to expand the graph for immersive exploration:

- Graph expands to **3 levels deep** â€” see connections of connections of connections
- More items displayed (up to 35 nodes)
- **Create Playlist** button to save your discoveries
- Same drag/zoom/click interactions

---

## ğŸ§  Smart Bubble Breaking

The graph is smart about preventing you from getting stuck in a franchise bubble:

### Collection Limits

- The graph won't show all 26 James Bond films â€” it intelligently limits items per franchise
- Larger franchises get slightly higher limits to stay representative
- This encourages discovery of diverse content

### AI-Powered Escape

When the graph detects you're stuck in a bubble (too many items from the same collection), it calls the AI to suggest thematically similar content from **different** franchises:

- These AI discoveries appear with **emerald green** connections
- They're semantically related but offer fresh perspectives
- Example: If exploring Star Wars, AI might suggest Dune, Battlestar Galactica, or Foundation

### Connection Validation

The graph validates connections to prevent weird matches:

- **Title pattern detection** â€” Catches when movies match only because they both have "Return of..." in the title
- **Genre gating** â€” Requires at least one shared genre for a valid connection
- **Collection diversity** â€” Prevents unrelated franchises from chaining together

---

## ğŸ“‹ Graph Playlists

Turn your graph explorations into playlists that sync to your media server!

### Creating a Playlist

1. Open a similarity graph and go **fullscreen**
2. Explore until you have a nice collection of related content
3. Click **Create Playlist**
4. Choose a name (or click âœ¨ for AI-generated name)
5. Add a description (or click âœ¨ for AI-generated description)
6. Click **Create**

### What Happens

- Playlist is created in Emby/Jellyfin with all the graph items
- Description/overview syncs to your media server
- A record is saved in Aperture for tracking
- Graph playlists appear on the **Playlists** page with a hub icon badge

### Managing Graph Playlists

- View all playlists (both channel-based and graph-based) on the Playlists page
- Delete with a **confirmation dialog** (no more accidental browser confirms!)
- Graph playlists show their source item and item count

---

## âš™ï¸ Similarity Graph Preferences

New user preferences to customize your graph experience:

### Hide Watched Content (Default: ON)

When enabled, movies and series you've already watched won't appear in the similarity graph. This helps you discover **new** content rather than seeing things you've already seen.

### Full Franchise Mode (Default: OFF)

When enabled, the collection limits are disabled and you can see entire franchises in the graph. Useful when you want to explore all entries in a series like James Bond, Marvel, or Star Trek.

**Access these settings:** User Settings â†’ Preferences tab â†’ Similarity Graph section

---

## ğŸ¨ UI/UX Improvements

### Graph Visualization
- **Larger poster nodes** for better visibility (100Ã—150px regular, 120Ã—180px center)
- **Taller compact view** (550px) to show more content without fullscreen
- **Smooth transitions** â€” graph fades in gently instead of chaotic initial animation
- **Circular pre-layout** â€” nodes start arranged in a circle for more stable settling

### Playlists Page
- **MUI confirmation dialog** replaces browser confirm for deletion
- **Graph playlists** integrated alongside channel playlists
- **Hub icon badge** identifies playlists created from graphs

### User Settings
- **Multi-column layout** for preferences on larger screens
- **Similarity Graph** preferences card with toggle switches

---

## ğŸ”§ Bug Fixes

### Emby/Jellyfin Playlist Overview
Fixed playlist descriptions not saving. The API requires:
1. Fetching the full item via `/Users/{userId}/Items/{id}` (not `/Items/{id}`)
2. Posting the complete object back with the updated Overview field

### Graph Re-rendering
Fixed the graph re-initializing every time you opened a dialog or showed a snackbar. Now uses:
- Callback refs to prevent effect re-runs
- Stable data keys based on node IDs

### Graph Expansion Limits
- Capped total nodes at 35 to prevent overwhelming graphs
- More conservative level limits for deep expansions

---

## ğŸ“Š Technical Details

### New Database Tables

**`similarity_validation_cache`** â€” Caches AI validation results for connection checks
- Prevents repeated AI calls for the same pair of items
- Indexed for fast lookups in both directions

**`graph_playlists`** â€” Tracks playlists created from similarity graphs
- Links to media server playlist ID
- Stores source item and type for context

### New User Preferences Columns

**`user_preferences.similarity_full_franchise`** â€” Boolean for full franchise mode
**`user_preferences.similarity_hide_watched`** â€” Boolean for hiding watched content

### New API Endpoints

- `GET /api/similarity/movie/:id?depth=N` â€” Get similar movies with multi-level expansion
- `GET /api/similarity/series/:id?depth=N` â€” Get similar series with multi-level expansion
- `POST /api/graph-playlists` â€” Create a playlist from graph nodes
- `POST /api/graph-playlists/ai-name` â€” Generate AI playlist name
- `POST /api/graph-playlists/ai-description` â€” Generate AI playlist description
- `GET /api/graph-playlists` â€” List user's graph playlists
- `DELETE /api/graph-playlists/:id` â€” Delete a graph playlist
- `GET /api/settings/user/similarity-prefs` â€” Get similarity preferences
- `PATCH /api/settings/user/similarity-prefs` â€” Update similarity preferences

---

## ğŸš€ Getting Started

1. **Update to v0.4.0** and run database migrations
2. **Navigate to any movie or series** detail page
3. **Click the Graph tab** to see the similarity visualization
4. **Explore!** Click posters to dive deeper, double-click to visit detail pages
5. **Go fullscreen** for the full experience with playlist creation

---

## Migration Notes

Three new database migrations will run automatically:
- `0072_similarity_validation_cache.sql`
- `0073_graph_playlists.sql`
- `0074_similarity_preferences.sql`

No manual intervention required.

---

Enjoy exploring your library in a whole new way! ğŸ¬ğŸ•¸ï¸

Let me know if you have any feedback or run into issues.

