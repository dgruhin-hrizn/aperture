# Aperture v0.4.7 Release Notes

Hey everyone! üëã

This release focuses on dashboard improvements and bug fixes to make your home screen more useful.

---

## ‚ú® New Features

### Two-Column Recently Watched

The Recently Watched card on the dashboard now displays **Movies** and **Series** in separate columns, making better use of the available space.

- **Movies column** (left): Shows your recently watched movies with play count
- **Series column** (right): Shows recently watched series with the last episode watched (e.g., S2E5)

### Improved Time Display

- **Recently Watched**: Now shows months and years for older items (e.g., "2mo 15d ago", "1y 3mo ago")
- **Recent Ratings**: Displays "Rated on Jan 11, 2026" format instead of relative time

### Libraries Excluded from Global Search

AI-generated libraries are now **excluded from global search** in Emby/Jellyfin. This keeps your search results clean ‚Äî when you search for a movie, you'll only see results from your main libraries, not duplicates from AI recommendation libraries.

**Affected libraries:**

- üçø AI Movie Recommendations
- üì∫ AI Series Recommendations
- üèÜ Top Picks libraries
- üëÄ Shows You Watch libraries

**Note:** Re-running the "Build Aperture Libraries" job will apply this setting to existing libraries.

### Library Default Sort: Date Added

AI recommendation libraries now **default to "Date Added" sort** (newest first) when users first visit them. This means your most recent recommendations appear at the top.

- Set automatically when granting users library access
- Uses the correct Emby Web / Jellyfin Web client identifiers
- Once a user changes their sort preference, it's remembered by their browser

**Affected libraries:**

- üçø AI Movie Recommendations
- üì∫ AI Series Recommendations
- üèÜ Top Picks libraries
- üëÄ Shows You Watch libraries

### Hidden from Continue Watching

AI recommendation library items are now **automatically hidden from Continue Watching**. If you start watching a movie from an AI recommendation library, it won't clutter your Continue Watching section on the home screen.

- Applied automatically after library scan completes
- Hidden for all users with access to the library
- Uses the Emby/Jellyfin `HideFromResume` API per-item

**Affected libraries:**

- üçø AI Movie Recommendations
- üì∫ AI Series Recommendations
- üèÜ Top Picks libraries
- üëÄ Shows You Watch libraries

**Note:** Re-running the "Build Aperture Libraries" job will apply this to existing items.

---

## üêõ Bug Fixes

### Metadata Sync Fix

Fixed an issue where **posters and metadata wouldn't update** for movies/series that already existed in your library.

**The problem:** When syncing from Emby/Jellyfin, if a movie existed by title+year but had a different internal ID (common with STRM libraries), the metadata update was silently skipped.

**The fix:** The sync jobs now properly update metadata for items matched by title+year, ensuring poster fixes and other changes in your media server are reflected in Aperture.

### Recently Watched Sorting

Fixed movies appearing in wrong order in Recently Watched. The issue was caused by NULL timestamps being sorted incorrectly.

### Rating Timestamps

Fixed an issue where **all ratings showed today's date** after a Trakt sync.

**The problem:** A database trigger was overwriting `updated_at` on every sync, even when ratings hadn't changed. Additionally, the Trakt sync was unconditionally updating timestamps.

**The fix:**

- Removed the interfering database trigger (via migration)
- Trakt sync now only updates timestamps when the rating value actually changes
- Migration automatically resets corrupted timestamps for existing users

### AI Explanation Batch Size (Ollama Context Window Fix)

The recommender now automatically adapts explanation generation based on your AI provider's context window:

| Provider                                                | Batch Size | Max Output Tokens |
| ------------------------------------------------------- | ---------- | ----------------- |
| **Large context** (OpenAI, Anthropic, Google, DeepSeek) | 10 items   | 3,000             |
| **Medium context** (Groq)                               | 5 items    | 1,500             |
| **Small context** (Ollama, OpenAI-compatible)           | 3 items    | 1,000             |

**Context window requirements:**

| Batch Size | Input Tokens | Output Tokens | Total Needed  |
| ---------- | ------------ | ------------- | ------------- |
| 10 items   | ~1,500       | 3,000         | ~4,500        |
| 5 items    | ~900         | 1,500         | ~2,400        |
| 3 items    | ~600         | 1,000         | **~1,600** ‚úÖ |

With the reduced batch size, explanation generation now fits comfortably within **Ollama's default 4096 context window** ‚Äî no need to manually increase `num_ctx`. The same recommendations are generated, just in smaller batches.

**Also improved:**
- Better error handling when AI returns malformed JSON (handles markdown code blocks, preamble text)
- Error messages now properly logged instead of empty `{}`

### Watch History Sync Improvements

**Full sync is now the default** ‚Äî The scheduled watch history sync jobs now always perform a **full sync** instead of delta sync. This ensures all watched items are captured, even if movies were added to Aperture after you'd already watched them.

**Consolidated jobs** ‚Äî The separate "Full Sync Watch History" manual jobs have been removed. The regular sync jobs now handle everything:

| Old Jobs | New (Consolidated) |
| -------- | ------------------ |
| Sync Movie Watch History (delta) | **Sync Movie Watch History** (full) |
| Full Sync Movie Watch History (manual) | ‚ùå Removed |
| Sync Series Watch History (delta) | **Sync Series Watch History** (full) |
| Full Sync Series Watch History (manual) | ‚ùå Removed |

**Pre-recommendation sync** ‚Äî The recommender also syncs watch history immediately before generating recommendations, ensuring recently watched content is properly excluded.

**Why this matters:** Delta sync could miss items if you watched something, then later added that movie/series to Aperture. The delta sync only checked for items modified after the last sync, missing those historical watches. Full sync catches everything.

### Playlist Overview Fix

Fixed an issue where **playlist descriptions weren't being saved** when creating or updating playlists. The fix ensures the correct item ID is used when posting updates to Emby/Jellyfin.

### Lint Fixes

- Fixed React Hook dependency warning in `RunningJobsWidget`
- Removed unused import in jobs routes

---

## üé® UI Improvements

### Renamed Library Build Jobs

The STRM/symlink library creation jobs now have clearer names:

| Old Name              | New Name                            |
| --------------------- | ----------------------------------- |
| Sync Movie Libraries  | **Build Aperture Movie Libraries**  |
| Sync Series Libraries | **Build Aperture Series Libraries** |

This better reflects what these jobs do ‚Äî they _build_ the AI recommendation libraries in your media server.

---

## üöÄ Update Instructions

### For Existing Docker Users

```bash
# Pull the latest image
docker compose pull

# Restart with new version
docker compose up -d
```

### For New Docker Users

```bash
# Pull the latest image
docker pull ghcr.io/your-org/aperture:latest

# Or use docker compose
docker compose up -d
```

The `:latest` tag always points to the most recent stable release.

---

## üìã Full Changelog

- `feat: split Recently Watched into Movies and Series columns`
- `feat(recommender): adapt explanation batch size based on AI provider`
- `feat(libraries): exclude AI-generated libraries from global search`
- `feat(libraries): set default sort to Date Added for AI recommendation libraries`
- `feat(libraries): hide AI library items from Continue Watching`
- `feat(recommender): sync watch history before generating recommendations`
- `refactor(jobs): simplify watch history sync - always use full sync`
- `refactor(jobs): remove redundant full-sync-watch-history jobs`
- `fix(explanations): improve error handling and JSON parsing for AI responses`
- `fix: remove user_ratings updated_at trigger that interfered with Trakt sync`
- `fix: dashboard improvements for ratings and recently watched`
- `fix: display rating date as 'Rated on Month Day, Year' format`
- `fix: correct recently watched sorting and improve date display`
- `fix(sync): update metadata for movies/series matched by title+year`
- `fix(playlists): use correct item ID for playlist overview updates`
- `style(jobs): rename library sync jobs to 'Build Aperture Libraries'`
- `fix(lint): add missing useEffect dependency in RunningJobsWidget`
- `fix(lint): remove unused subscribeToAllJobs import`

---

Enjoy the improvements! üçø
