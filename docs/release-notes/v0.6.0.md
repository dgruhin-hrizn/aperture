# Aperture v0.6.0 Release Notes

Hey everyone! ğŸ‘‹

This is a major release focused on **API architecture improvements**, **bug fixes**, and an important **license change**. We've completely reorganized the API for better maintainability and added comprehensive OpenAPI documentation.

---

## ğŸ“œ License Change: MIT â†’ AGPL-3.0

**Aperture is now licensed under the GNU Affero General Public License v3.0.**

### What This Means

- âœ… You can still use Aperture freely for personal use
- âœ… You can modify and self-host Aperture
- âœ… Source code remains open and auditable
- âš ï¸ If you modify Aperture and provide it as a network service, you must release your source code under AGPL-3.0

This change protects the project from proprietary forks while keeping it fully open source. The AGPL-3.0 is OSI-approved and widely used by projects like Nextcloud and Grafana.

---

## ğŸ—ï¸ API Architecture Overhaul

The entire API has been reorganized from monolithic route files into a modular, maintainable structure:

### New Structure

```
routes/
â”œâ”€â”€ movies/
â”‚   â”œâ”€â”€ index.ts        # Route registration
â”‚   â”œâ”€â”€ schemas.ts      # OpenAPI schemas
â”‚   â”œâ”€â”€ types.ts        # TypeScript interfaces
â”‚   â””â”€â”€ handlers/       # Individual endpoint handlers
â”‚       â”œâ”€â”€ list.ts
â”‚       â”œâ”€â”€ detail.ts
â”‚       â”œâ”€â”€ filters.ts
â”‚       â””â”€â”€ ...
â”œâ”€â”€ series/
â”œâ”€â”€ settings/
â”œâ”€â”€ recommendations/
â””â”€â”€ ...
```

### Benefits

- **Better maintainability** â€” Each domain is self-contained
- **Comprehensive OpenAPI docs** â€” Visit `/openapi` for full API documentation
- **Type safety** â€” Shared types prevent inconsistencies
- **Easier testing** â€” Handlers can be tested in isolation

---

## âœ¨ Swagger UI Branding

The OpenAPI documentation at `/openapi` now features:

- **Aperture logo** in the header
- **"Aperture API"** branding
- **Correct GitHub links** to documentation and repository
- **AGPL-3.0 license** information

---

## ğŸ› Fixed: Poster Images Not Loading

### The Problem

After internal refactoring, poster images stopped loading on:
- Browse page
- Media detail pages
- Dashboard sections

### The Cause

Fastify's response serialization was filtering out `poster_url` and `backdrop_url` fields because the OpenAPI schemas used camelCase (`posterUrl`) while the database returns snake_case (`poster_url`).

### The Fix

Removed response schemas from pass-through routes (movies list, series list, detail endpoints) to allow database fields to pass through without serialization filtering. Routes with explicit data transformation (like dashboard) continue to work with their schemas.

---

## ğŸ› Fixed: Playlist Navigation Using Wrong ID

### The Problem

Clicking a poster in the similarity playlist modal navigated to the wrong page (e.g., `/movies/12345` instead of the correct Aperture UUID).

### The Cause

The `getGraphPlaylistItems` function was returning the media server item ID (Jellyfin/Emby ID) instead of the Aperture UUID.

### The Fix

Enhanced `getGraphPlaylistItems` to:
1. Fetch items from media server
2. Look up Aperture UUIDs by matching `provider_item_id`
3. Return items with correct Aperture UUIDs and media type

---

## âš¡ Discovery: Shared Candidate Pool

Multi-user Discovery now uses a **shared candidate pool** for dramatically improved efficiency:

### How It Works

1. **Shared enrichment** â€” TMDb data is fetched once and stored in a shared pool
2. **User-specific scoring** â€” Each user's candidates are scored against their taste profile
3. **Reduced API calls** â€” Eliminates duplicate TMDb requests across users

### Performance Gains

| Scenario | Before | After |
|----------|--------|-------|
| 5 users, 100 candidates each | 500 TMDb calls | ~100 TMDb calls |
| API rate limit risk | High | Low |

### Database Schema

New `discovery_candidate_pool` table stores shared candidate data with full TMDb metadata.

---

## ğŸš€ Update Instructions

### For Docker Users

```bash
# Pull the latest image
docker compose pull

# Restart with new version
docker compose up -d
```

Database migrations will be applied automatically on startup.

---

## ğŸ“‹ Full Changelog

**Major Changes:**
- `chore: switch license from MIT to AGPL-3.0`
- `feat: reorganize API into modular route structure with OpenAPI schemas`
- `feat: add Aperture branding to Swagger UI`

**Bug Fixes:**
- `fix: resolve poster images not loading on browse and detail pages`
- `fix: playlist item navigation using wrong ID (media server ID vs Aperture UUID)`

**Improvements:**
- `feat(discovery): add shared candidate pool for efficient multi-user processing`
- `docs: update Swagger links to correct GitHub repository`

---

## Migration Notes

### License Change

If you have forked Aperture or are providing it as a service, please review the [AGPL-3.0 license terms](https://www.gnu.org/licenses/agpl-3.0.html).

### API Changes

The API endpoints themselves have not changed â€” only the internal organization. All existing integrations should continue to work without modification.

### Database Migration

A new migration (`0098_discovery_pool.sql`) creates the shared discovery pool table. This runs automatically on startup.
