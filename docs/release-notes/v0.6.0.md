# Aperture v0.6.0 Release Notes

Hey everyone! ğŸ‘‹

This is a major release packed with new features including **API key authentication**, **hybrid discovery with lazy enrichment**, **API architecture improvements**, and an important **license change**. We've completely reorganized the API for better maintainability and added comprehensive OpenAPI documentation.

---

## ğŸ“œ License Change: MIT â†’ AGPL-3.0

**Aperture is now licensed under the GNU Affero General Public License v3.0.**

### What This Means

- âœ… You can still use Aperture freely for personal use
- âœ… You can modify and self-host Aperture
- âœ… Source code remains open and auditable
- âš ï¸ If you modify Aperture and provide it as a network service, you must release your source code under AGPL-3.0

This change protects the project from proprietary forks while keeping it fully open source. The AGPL-3.0 is OSI-approved and widely used by projects like Nextcloud and Grafana.

---

## ğŸ”‘ API Key Authentication

**New feature: Programmatic API access with API keys!**

You can now create API keys for external integrations, scripts, and automation. This enables building custom tools that interact with Aperture.

### Features

- **Admin UI** â€” Manage keys in Settings â†’ System â†’ API Keys
- **Secure storage** â€” Keys are SHA-256 hashed in the database
- **Flexible expiration** â€” Never expire, or 7/30/60/90/180/365 days
- **Usage tracking** â€” `last_used_at` timestamp for security monitoring
- **Easy identification** â€” Keys use `apt_` prefix (e.g., `apt_abc123...`)
- **Revocation** â€” Soft delete with audit trail

### Usage

Include the API key in your requests:

```bash
curl -H "X-API-Key: apt_your_key_here" https://your-aperture/api/movies
```

### Creating API Keys

1. Navigate to **Settings â†’ System**
2. Scroll to **API Keys** section
3. Click **Create API Key**
4. Choose a name and expiration period
5. Copy the key (shown only once!)

---

## âš¡ Discovery: Hybrid Mode with Lazy Enrichment

Discovery has been **completely overhauled** for dramatically better performance and filter coverage.

### Lazy Enrichment (60-80% Faster Generation)

Not all candidates need full metadata upfront:

| Enrichment Level | What's Fetched | When |
|------------------|----------------|------|
| **Basic** (all candidates) | Poster, language, genres | Always |
| **Full** (top 75-150) | Cast, crew, runtime, keywords | On-demand |

This reduces TMDb API calls by 60-80% during discovery generation.

### Dynamic Expansion

When you apply restrictive filters (language, genre, year), Discovery now **automatically fetches more content** to maintain ~50 results:

1. Filter reduces results below 20 candidates
2. Aperture queries TMDb with your active filters
3. New candidates are merged and re-ranked
4. Results expand seamlessly in the UI

### Scaled Candidate Pools

| Parameter | Before | After |
|-----------|--------|-------|
| Candidates per source | 50 | 200 |
| Total candidates | 200 | 1,000 |
| Enriched candidates | 75 | 150 |

This ensures you always have plenty of recommendations, even with strict filters.

---

## ğŸ“º Jellyseerr: Season Selection for TV Series

When requesting TV series through Jellyseerr, you can now **select specific seasons** instead of requesting the entire show.

A new modal appears when requesting a series, letting you:
- View all available seasons
- Select one or more seasons to request
- See which seasons are already available

---

## ğŸ—ï¸ API Architecture Overhaul

The entire API has been reorganized from monolithic route files into a modular, maintainable structure:

### New Structure

```
routes/
â”œâ”€â”€ movies/
â”‚   â”œâ”€â”€ index.ts        # Route registration
â”‚   â”œâ”€â”€ schemas.ts      # OpenAPI schemas
â”‚   â”œâ”€â”€ types.ts        # TypeScript interfaces
â”‚   â””â”€â”€ handlers/       # Individual endpoint handlers
â”‚       â”œâ”€â”€ list.ts
â”‚       â”œâ”€â”€ detail.ts
â”‚       â”œâ”€â”€ filters.ts
â”‚       â””â”€â”€ ...
â”œâ”€â”€ series/
â”œâ”€â”€ settings/
â”œâ”€â”€ recommendations/
â””â”€â”€ ...
```

### Benefits

- **Better maintainability** â€” Each domain is self-contained
- **Comprehensive OpenAPI docs** â€” Visit `/openapi` for full API documentation
- **Type safety** â€” Shared types prevent inconsistencies
- **Easier testing** â€” Handlers can be tested in isolation

---

## âœ¨ Swagger UI Branding

The OpenAPI documentation at `/openapi` now features:

- **Aperture logo** in the header
- **"Aperture API"** branding
- **Correct GitHub links** to documentation and repository
- **AGPL-3.0 license** information
- **Collapsed tag sections** by default for easier navigation

---

## âš¡ Discovery: Shared Candidate Pool

Multi-user Discovery now uses a **shared candidate pool** for dramatically improved efficiency:

### How It Works

1. **Shared enrichment** â€” TMDb data is fetched once and stored in a shared pool
2. **User-specific scoring** â€” Each user's candidates are scored against their taste profile
3. **Reduced API calls** â€” Eliminates duplicate TMDb requests across users

### Performance Gains

| Scenario | Before | After |
|----------|--------|-------|
| 5 users, 100 candidates each | 500 TMDb calls | ~100 TMDb calls |
| API rate limit risk | High | Low |

### Database Schema

New `discovery_candidate_pool` table stores shared candidate data with full TMDb metadata.

---

## ğŸ› Fixed: Poster Images Not Loading

### The Problem

After internal refactoring, poster images stopped loading on:
- Browse page
- Media detail pages
- Dashboard sections

### The Cause

Fastify's response serialization was filtering out `poster_url` and `backdrop_url` fields because the OpenAPI schemas used camelCase (`posterUrl`) while the database returns snake_case (`poster_url`).

### The Fix

Removed response schemas from pass-through routes (movies list, series list, detail endpoints) to allow database fields to pass through without serialization filtering. Routes with explicit data transformation (like dashboard) continue to work with their schemas.

---

## ğŸ› Fixed: Playlist Navigation Using Wrong ID

### The Problem

Clicking a poster in the similarity playlist modal navigated to the wrong page (e.g., `/movies/12345` instead of the correct Aperture UUID).

### The Cause

The `getGraphPlaylistItems` function was returning the media server item ID (Jellyfin/Emby ID) instead of the Aperture UUID.

### The Fix

Enhanced `getGraphPlaylistItems` to:
1. Fetch items from media server
2. Look up Aperture UUIDs by matching `provider_item_id`
3. Return items with correct Aperture UUIDs and media type

---

## ğŸš€ Update Instructions

### For Docker Users

```bash
# Pull the latest image
docker compose pull

# Restart with new version
docker compose up -d
```

Database migrations will be applied automatically on startup.

---

## ğŸ“‹ Full Changelog

**New Features:**
- `feat: Add API key authentication and OpenAPI documentation`
- `feat(discovery): implement hybrid discovery with lazy enrichment and dynamic expansion`
- `feat(discovery): scale candidate pool for better filter coverage`
- `feat(discovery): add shared candidate pool for efficient multi-user processing`
- `feat: add Jellyseerr season selection modal for TV series requests`
- `feat: add Aperture branding to Swagger UI`

**Major Changes:**
- `chore: switch license from MIT to AGPL-3.0`
- `feat: reorganize API into modular route structure with OpenAPI schemas`

**Bug Fixes:**
- `fix: resolve poster images not loading on browse and detail pages`
- `fix: playlist item navigation using wrong ID (media server ID vs Aperture UUID)`

**Improvements:**
- `docs: update Swagger links to correct GitHub repository`
- `style: collapse Swagger UI tag sections by default`
- `docs: improve API authentication instructions in Swagger`

---

## Migration Notes

### License Change

If you have forked Aperture or are providing it as a service, please review the [AGPL-3.0 license terms](https://www.gnu.org/licenses/agpl-3.0.html).

### API Changes

The API endpoints themselves have not changed â€” only the internal organization. All existing integrations should continue to work without modification.

**New endpoints:**
- `GET /api/api-keys` â€” List API keys (admin only)
- `POST /api/api-keys` â€” Create API key (admin only)
- `DELETE /api/api-keys/:id` â€” Delete API key (admin only)
- `POST /api/api-keys/:id/revoke` â€” Revoke API key (admin only)
- `POST /api/discovery/:mediaType/expand` â€” Dynamically expand discovery results

### Database Migrations

Three new migrations run automatically on startup:
- `0096_discovery_enrichment.sql` â€” Adds `is_enriched` column to discovery candidates
- `0097_api_keys.sql` â€” Creates API keys table
- `0098_discovery_pool.sql` â€” Creates shared discovery pool table
